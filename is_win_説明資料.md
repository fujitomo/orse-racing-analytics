# 🏇 is_win関連データ説明資料

## 📋 概要

このドキュメントは、競馬レースレベル分析における`is_win`および`is_placed`フラグの詳細な説明資料です。これらのフラグは、第0段階「データ整備」で作成された重要な目的変数として、因果推論分析の基盤となります。

---

## 🎯 データ基本情報

| 項目 | 内容 |
|------|------|
| **データソース** | JRA-VAN競馬データ（SED: 競走成績データ） |
| **処理段階** | 第0段階: データ整備（Phase 0） |
| **出力場所** | `export/race_level_analysis/` |
| **ファイル形式** | 日付別分割CSVファイル（例: `SED230326_race_level_analysis.csv`） |
| **総レース数** | 528,088レース |
| **総馬数** | 71,755頭 |
| **特徴量数** | 137カラム |

---

## 🏆 レースレベル分析の主要特徴量

このデータには、因果推論分析計画書の「2.2.2 分析で使う主要な「ものさし」」に基づく包括的な特徴量が含まれています。

### **🎯 レースレベル（race_level）**

**レースレベルとは、「そのレースがどれくらい価値の高い、重要なレースか」を0-10の数字で表したものです。**

#### **🏆 基本的な考え方：「格の高いレース」ほど高い数値**

競馬には「格の高いレース」と「格の低いレース」があります。これを数値化したのがレースレベルです。

**【格の高いレース】レベル8-10**
- **G1レース（レベル約9-10）**: 日本ダービー、有馬記念など、年に数回しかない超一流レース
- **G2レース（レベル約7-9）**: 皐月賞、オークスなど、月に1-2回程度の一流レース
- **G3レース（レベル約6-8）**: 中山記念など、重要だが少し格下のレース

**【格の中程度のレース】レベル5-7**
- **重賞・特別戦（レベル約5-7）**: 各競馬場で週末に行われる、ある程度重要なレース

**【格の低いレース】レベル0-5**
- **一般戦・未勝利戦（レベル約0-5）**: 新馬や勝ち上がりを目指す馬のためのレース

#### **🔢 レースレベルの決まり方：2つの要素で判定**

レースレベルは、**「レースの格」6割 + 「賞金の額」4割** で決まります。

**1️⃣ レースの格（6割の重み）**
- 「G1」「G2」「G3」といった正式な格付けを重視
- JRAが公式に認定している格式が基準
- **例**: 同じ距離・同じ賞金でも、「G1」と名前がついていれば断然高いレベル

**2️⃣ 賞金の額（4割の重み）**
- 1着の馬がもらえる賞金の額
- 賞金が高い = 重要なレース = レベルが高い
- **例**: 賞金1億円のレースは、賞金1000万円のレースより明らかに格上

#### **🏃 距離による「格上げ・格下げ」調整**

同じG1でも、距離によって価値が変わると考えられています：

**🔥 価値が高く評価される距離（レベル上昇）**
- **2000m前後（1.45倍）**: 日本ダービー、天皇賞など、最も権威ある距離
- **中距離1800-2000m（1.35倍）**: 多くの名馬が活躍する主戦場

**⚖️ 標準的な距離**
- **マイル1400-1800m（1.0倍）**: 基準となる距離、調整なし

**📉 やや価値が下がる距離（レベル低下）**
- **スプリント1200-1400m（0.85倍）**: 短距離専門、特殊な能力が必要
- **超長距離2600m以上（1.25倍）**: スタミナ特化、出走頭数が少ない

#### **🎯 具体例でわかるレースレベル**

| レース名 | 格付け | 賞金 | 距離 | レースレベル | 理由 |
|----------|--------|------|------|-------------|------|
| **日本ダービー** | G1 | 3億円 | 2400m | **9.8** | 最高格式 × 最高賞金 × 権威ある距離 |
| **マイルチャンピオンシップ** | G1 | 1.3億円 | 1600m | **8.5** | G1だがマイル戦（距離補正で若干下がる） |
| **中山記念** | G3 | 5000万円 | 1800m | **6.8** | G3だが賞金高め × 良い距離 |
| **新馬戦** | なし | 500万円 | 1800m | **2.1** | 格付けなし × 低賞金（でも中距離なので少し上がる） |

#### **💡 なぜこの計算方法なのか？**

**理由1**: 「格」を重視（6割）しているのは、JRAの公式格付けが競馬界で最も信頼される基準だから

**理由2**: 「賞金」も考慮（4割）するのは、同じG3でも賞金1億円と賞金3000万円では明らかに重要度が違うから

**理由3**: 「距離補正」をするのは、2000m前後が競馬で最も権威ある距離とされ、短距離・超長距離は特殊な条件だから

この方法により、**「客観的で、競馬界の常識とも一致する、レースの重要度ランキング」**ができあがります。

### **🐎 馬能力（horse_ability）**

**馬能力とは、「その馬がどれくらい速く走れるか、強いか」を数値で表したものです。**

#### **🏇 馬能力の基本的な考え方**

人間に例えると、**「100m走のタイム」や「偏差値」のようなもの**です。数値が高いほど強い馬、数値が低いほど弱い馬ということになります。

**【強い馬】高い数値**
- トップレベルの馬：常にG1レースで上位に来る、年間数億円稼ぐ馬
- 中堅の実力馬：たまにG2・G3で勝つ、安定して上位に来る馬

**【普通の馬】中程度の数値**
- 一般的な馬：週末の特別戦や条件戦で頑張っている馬
- 勝ち上がり途中の馬：これから強くなるかもしれない馬

**【弱い馬】低い数値**
- 未勝利の馬：まだ1回も勝ったことがない馬
- 衰えた馬：昔は強かったが年齢で能力が落ちた馬

#### **📊 馬能力の測定方法：2つの方法を使い分け**

この分析では、馬能力を**2つの方法**で測定しています：

**1️⃣ 観測された能力（見かけ上の能力）**
- **どうやって測るか**: IDMやスピード指数などの既存の指標をまとめたもの
- **何の数値か**: 「実際のレース結果から逆算した、その馬の強さ」
- **問題点**: その日の馬場状態や運・不運の影響が混じっている

**具体例**: 「この馬はいつもタイムが良いから能力80点」→ でも実は、たまたま有利な馬場で走ることが多かっただけかも？

**2️⃣ バイアス補正後能力（真の能力）**
- **どうやって測るか**: 観測された能力から、馬場や運の影響を統計的に取り除いたもの
- **何の数値か**: 「条件が同じなら、この馬は本当はこれくらい強い」という純粋な実力
- **目的**: より正確な馬の実力を把握する

**具体例**: 「馬場の有利さを除くと、この馬の真の実力は75点」→ 思ったより少し低いけど、これが本当の実力

#### **🤔 なぜ2つの能力を分けるのか？**

**問題**: 普通の能力指標は「汚れている」
- 「強い馬」だと思っていても、実は**有利な条件で走っただけ**かもしれない
- 「弱い馬」だと思っていても、実は**不利な条件でいつも走らされている**かもしれない

**解決**: 条件の影響を取り除いて比較する
- **観測された能力**: 「実際の成績から見た強さ」（条件の影響込み）
- **補正後能力**: 「条件を同じにしたときの本当の強さ」（条件の影響抜き）

#### **🎯 具体例：馬場の影響を考えてみる**

| 馬名 | よく走る条件 | 観測された能力 | 補正後能力 | 解釈 |
|------|-------------|---------------|-----------|------|
| **A馬** | 内枠・良馬場が多い | **85点** | **78点** | 実は有利な条件で走ることが多かった |
| **B馬** | 外枠・重馬場が多い | **72点** | **79点** | 実は不利な条件で頑張っていた！ |
| **C馬** | 条件バランス良い | **80点** | **80点** | 表面の成績と実力が一致 |

この例だと、**B馬が実は一番強い**ということになります。普通に成績だけ見ていたら見逃してしまう発見です。

#### **💡 この分析で馬能力をどう使うか？**

**目的**: 「馬の強さ」が「レース結果」にどう影響するかを正しく分析する

**使い方**:
- **補正前能力**: 「普通の競馬ファンが思う馬の強さ」として使用
- **補正後能力**: 「統計的に正しい馬の強さ」として使用
- **両方を比較**: どちらを使うかで分析結果がどう変わるかを確認

この使い分けにより、**「本当は何が勝敗を分けているのか」**をより正確に分析できるようになります。

### **📊 トラックバイアス（track_bias）**

**トラックバイアスとは、「その日のコースや馬場で、どの馬が有利・不利になるか」を数値化したものです。**

#### **🏟️ トラックバイアスの基本的な考え方**

スポーツに例えると、**「野球のホーム・アウェイ」や「サッカーの風向き」のようなもの**です。同じ実力の馬でも、その日の条件によって結果が大きく変わります。

**【有利な条件】プラスの数値**
- その日の馬場・枠順・作戦が、その馬に合っている
- 普段より良い結果が期待できる

**【普通の条件】ゼロに近い数値**
- 特に有利でも不利でもない、平均的な条件
- 馬の実力通りの結果が期待できる

**【不利な条件】マイナスの数値**
- その日の馬場・枠順・作戦が、その馬に合っていない
- 普段より悪い結果になりがち

#### **🔍 トラックバイアスの3つの要素**

**1️⃣ 脚質バイアス（4割の重み）**
- **何を見るか**: 「逃げ・先行・差し・追込」のどの作戦が有利か
- **なぜ起こるか**: その日のペースや馬場状態によって、有利な作戦が変わる

**具体例**:
- **逃げ有利な日**: 先頭を走る馬がそのまま勝ちやすい（ペースが遅い・馬場が渋い）
- **差し有利な日**: 後ろから追い込む馬が勝ちやすい（ペースが速い・馬場が軽い）

**2️⃣ 枠順バイアス（3割の重み）**
- **何を見るか**: 「内枠（1-4番）」と「外枠（5-8番以上）」のどちらが有利か
- **なぜ起こるか**: コースの形状や馬場の状態によって、スタート位置の有利さが変わる

**具体例**:
- **内枠有利な日**: 内側のコースが良い状態、距離ロスが少ない
- **外枠有利な日**: 内側の馬場が悪い、外を回った方が速い

**3️⃣ 馬場状態バイアス（3割の重み）**
- **何を見るか**: 「良・稍重・重・不良」のどの馬場状態か
- **なぜ起こるか**: 雨や馬場の整備状況によって、走りやすさが変わる

**具体例**:
- **良馬場**: 晴れて乾いた、最も走りやすい状態（基準）
- **重馬場**: 雨で泥っぽい、パワーのある馬が有利

#### **🎯 具体例：ある日の東京競馬場**

**その日の状況**:
- 雨が降って馬場が重い
- 内側のコースが特に悪い状態
- ペースが遅くなりがち

**トラックバイアスの判定**:
- **脚質**: 逃げ・先行有利（+0.3点）← ペースが遅いから
- **枠順**: 外枠有利（+0.2点）← 内側の馬場が悪いから
- **馬場**: 重馬場（-0.2点）← 基準より走りにくいから
- **総合**: +0.3 × 0.4 + 0.2 × 0.3 - 0.2 × 0.3 = **+0.12点**

**この日出走する馬への影響**:
- **A馬（逃げ・外枠）**: +0.12点の恩恵 → 普段より好結果が期待
- **B馬（追込・内枠）**: -0.12点の不利 → 普段より苦戦が予想
- **C馬（先行・中枠）**: 影響はやや小さい

#### **🤔 なぜトラックバイアスを測るのか？**

**問題**: 馬の実力を正しく評価できない
- 実力のない馬が、たまたま有利な条件で勝ってしまう
- 実力のある馬が、不利な条件で負けてしまう
- 表面的な結果だけ見ていると、本当の強さがわからない

**解決**: 条件の影響を数値化して考慮する
- **有利だった馬**: 「実力 + トラックバイアス = 結果」として分析
- **不利だった馬**: 「実力 - トラックバイアス = 結果」として分析
- **真の実力**: 条件の影響を除いた、本当の馬の強さを把握

#### **💡 この分析でトラックバイアスをどう使うか？**

**目的**: 「条件による運・不運」を「馬の実力」から正しく分離する

**使い方**:
1. **馬能力の補正**: 見かけ上の能力から条件の影響を除去
2. **予測の精度向上**: 今日の条件を考慮して、より正確な予想
3. **因果関係の解明**: 本当は何が勝敗を決めているのかを分析

この測定により、**「運ではなく実力による競馬分析」**が可能になります。

### **⏱️ 走破タイム特徴量**

**走破タイム特徴量とは、「その馬がどれくらい速く走ったか」を、公平に比較できるように調整した数値です。**

#### **🏃 走破タイムの基本的な考え方**

陸上競技に例えると、**「100mのタイムと400mのタイムを直接比較する」ようなもの**です。距離が違えば当然タイムも違うので、何らかの調整が必要になります。

**問題**: そのままのタイムは比較できない
- 1200mで1分10秒と、2400mで2分25秒、どちらが速い？
- 良馬場での1分30秒と、重馬場での1分35秒、どちらが速い？
- 強いメンバーでの2着と、弱いメンバーでの1着、どちらが価値がある？

**解決**: 条件を揃えて比較できるようにする

#### **📊 5つの走破タイム指標の使い分け**

**1️⃣ distance_adjusted_time（距離補正タイム）**
- **何の数値か**: 全てのタイムを「2000mだったら何秒か」に換算
- **使い道**: 距離が違うレース同士でも、タイムの速さを直接比較できる

**具体例**:
- 1200m（1分10秒）→ 2000m換算では「1分58秒相当」
- 2400m（2分25秒）→ 2000m換算では「2分01秒相当」
- **結果**: 1200mのレースの方が速いペースだったとわかる

**2️⃣ time_zscore（相対的タイム）**
- **何の数値か**: 「同じ条件の馬の中で、どれくらい速かったか」を数値化
- **使い道**: 馬場状態や距離の影響を除いて、純粋な速さを比較

**具体例**:
- ある馬のタイム：1分35秒
- 同じ条件の平均タイム：1分40秒
- 同じ条件の標準的なバラつき：3秒
- **z-score**: (1分35秒 - 1分40秒) ÷ 3秒 = **-1.67**（マイナスは速いことを意味）

**3️⃣ speed_index（速度指標）**
- **何の数値か**: 1分間で何メートル走れるかの速度
- **使い道**: 距離に関係なく、純粋な「足の速さ」を比較

**具体例**:
- 2000mを2分で走った馬：2000m ÷ 2分 = **1000m/分**
- 1200mを1分12秒で走った馬：1200m ÷ 1.2分 = **1000m/分**
- **結果**: どちらも同じ速度で走ったとわかる

**4️⃣ time_ratio（基準タイム比）**
- **何の数値か**: その距離の平均的なタイムと比べて、どれくらい速いか
- **使い道**: 「その距離では速いのか遅いのか」の判定

**具体例**:
- その馬のタイム：1分35秒
- その距離の平均タイム：1分40秒
- **time_ratio**: 1分35秒 ÷ 1分40秒 = **0.95**（1.0より小さいほど速い）

**5️⃣ time_rank_in_race（レース内順位）**
- **何の数値か**: そのレースの中で、タイム順に並べた時の順位
- **使い道**: 着順とタイムの関係を分析

**具体例**:
- 着順は5着だったが、タイムは3番目に速かった
- **解釈**: 不利な展開や事故があったかもしれない

#### **🎯 具体例：同じ馬の異なるレースでの走破タイム**

| レース | 距離 | 実際のタイム | 距離補正タイム | z-score | speed_index | time_ratio |
|--------|------|-------------|-------------|---------|-------------|------------|
| **A競走** | 1600m | 1分32秒 | 1分55秒 | **-1.2** | 1043m/分 | **0.94** |
| **B競走** | 2000m | 1分58秒 | 1分58秒 | **-0.8** | 1017m/分 | **0.97** |
| **C競走** | 2400m | 2分28秒 | 2分03秒 | **+0.3** | 973m/分 | **1.02** |

**この表からわかること**:
- **A競走が最も良い内容**: z-scoreが一番低い（速い）、time_ratioも最小
- **C競走は不調**: 全ての指標で劣る
- **距離補正タイムだけ見ると**: A競走(1分55秒) > B競走(1分58秒) > C競走(2分03秒)

#### **🤔 なぜこんなに細かく分けるのか？**

**目的**: 「本当に速い馬」と「たまたま速いタイムが出た馬」を区別する

**使い分けの理由**:
- **距離補正タイム**: 「絶対的な速さ」を知りたい時
- **z-score**: 「その条件での相対的な速さ」を知りたい時
- **speed_index**: 「馬のスピード能力」を知りたい時
- **time_ratio**: 「その距離での適性」を知りたい時
- **time_rank**: 「展開の影響」を知りたい時

#### **💡 この分析で走破タイム特徴量をどう使うか？**

**主要な分析テーマ**: 「速いタイムで走ること」が「上位入線」にどれくらい影響するか

**分析での使い方**:
1. **因果関係の解明**: レースレベル → タイム → 複勝率の流れを追跡
2. **媒介効果の測定**: レースの格がタイムを通して結果に与える影響
3. **条件の統制**: 距離・馬場状態の違いを調整して、純粋な速さの効果を測定

この多角的な測定により、**「速さ」の正体と「勝利」への貢献度**を科学的に解明できます。

### **📏 距離カテゴリ（distance_category）**

距離帯による分類です。

| カテゴリ | 距離帯 | 特徴 |
|----------|--------|------|
| **sprint** | 0-1400m | スプリント戦 |
| **mile** | 1401-1800m | マイル戦 |
| **middle** | 1801-2000m | 中距離戦 |
| **long** | 2001-2400m | 中長距離戦 |
| **extra_long** | 2401m以上 | 長距離戦 |

### **🔄 その他要因（バックドア要因）**

因果推論で統制すべき変数群です。

| 要因 | データ化方法 | 役割 |
|------|-------------|------|
| **騎手** | 過去成績・勝率でランク化 | 交絡因子 |
| **斤量** | 数値（kg） | 直接効果要因 |
| **血統** | ダミー変数化 | 遺伝的要因 |
| **馬場状態** | カテゴリ変数 | 環境要因 |
| **枠番** | 数値(1-8+) | 位置的要因 |

---

## 🔄 is_win・is_placed フラグの定義

### **is_win フラグ**

```python
df["is_win"] = df["着順"] == 1
```

| 項目 | 詳細 |
|------|------|
| **定義** | 1着入線フラグ（勝利フラグ） |
| **データ型** | ブール値（True/False） |
| **値の意味** | `True`: 1着、`False`: 2着以下 |
| **用途** | 勝率分析、因果推論の目的変数 |

### **is_placed フラグ**

```python
df["is_placed"] = df["着順"] <= 3
```

| 項目 | 詳細 |
|------|------|
| **定義** | 複勝（3着以内）入線フラグ |
| **データ型** | ブール値（True/False） |
| **値の意味** | `True`: 1-3着、`False`: 4着以下 |
| **用途** | 複勝率分析、因果推論の目的変数 |

---

## 📊 実データでの統計（サンプル: 2023年3月26日）

### **基本統計**

| 指標 | 値 | 割合 |
|------|-----|------|
| **総出走馬数** | 477頭 | 100.0% |
| **勝利馬数** | 36頭 | 7.547% |
| **複勝馬数** | 113頭 | 23.690% |

### **is_win分布**

| is_win | 馬数 | 割合 |
|--------|------|------|
| **False** | 441頭 | 92.453% |
| **True** | 36頭 | 7.547% |

### **is_placed分布**

| is_placed | 馬数 | 割合 |
|-----------|------|------|
| **False** | 364頭 | 76.310% |
| **True** | 113頭 | 23.690% |

---

## 🔗 着順との関係性

### **着順とis_winの対応**

| 着順 | is_win=False | is_win=True | 合計 |
|------|-------------|-------------|------|
| **0** （出走取消等） | 5 | 0 | 5 |
| **1** | 0 | **36** | 36 |
| **2** | 36 | 0 | 36 |
| **3** | 36 | 0 | 36 |
| **4以下** | 364 | 0 | 364 |

### **着順とis_placedの対応**

| 着順 | is_placed=False | is_placed=True | 合計 |
|------|----------------|----------------|------|
| **0** （出走取消等） | 0 | **5** | 5 |
| **1** | 0 | **36** | 36 |
| **2** | 0 | **36** | 36 |
| **3** | 0 | **36** | 36 |
| **4以下** | 364 | 0 | 364 |

---

## 🧮 作成プロセス

### **1. データソース**

```
JRA-VAN SEDデータ（競走成績） 
    ↓
SED+SRBデータ統合（with_bias）
    ↓
レースレベル分析用特徴量エンジニアリング
```

### **2. 処理ファイル**

| ファイル | 役割 |
|----------|------|
| `horse_racing/data/processors/race_level_processor.py` | 特徴量エンジニアリング |
| `process_race_data.py` | 統合処理スクリプト |

### **3. 実装コード**

```python
def _calculate_race_level_features(self, df: pd.DataFrame) -> pd.DataFrame:
    """1. レースレベル特徴量の計算"""
    
    # 基本的な成績フラグ
    df["is_win"] = df["着順"] == 1      # 勝利フラグ
    df["is_placed"] = df["着順"] <= 3   # 複勝フラグ
    
    return df
```

---

## 🔗 特徴量間の因果関係構造

計画書の因果ダイアグラムに基づく、主要特徴量間の関係性です。

### **📊 因果関係の流れ**

```
レースレベル → 馬能力 → 走破タイム → 複勝率
    ↓           ↓         ↓
    └→ トラックバイアス ────┘
                ↓
        バックドア要因（騎手・斤量・血統等）
```

### **🎯 各関係性の説明**

| 因果関係 | 説明 | 分析での重要性 |
|----------|------|---------------|
| **レースレベル → 馬能力** | 格の高いレースに強い馬が集まる（選抜バイアス） | 交絡因子として統制が必要 |
| **馬能力 → 走破タイム** | 能力の高い馬ほど速いタイムで走る | 媒介効果の主要経路 |
| **トラックバイアス → 走破タイム** | 馬場・枠順がタイムに直接影響 | 直接効果として測定 |
| **走破タイム → 複勝率** | 速いタイムの馬ほど上位入線 | 最終的な結果変数 |
| **レースレベル → 複勝率** | G1等の特殊環境が着順に影響 | 直接効果の可能性 |
| **トラックバイアス → 馬能力** | 能力指標がバイアスで汚染される | 測定誤差として補正が必要 |

### **⚠️ 重要な注意点**

#### **測定誤差の問題**
- **馬能力**の「観測された値」は、過去レースでのトラックバイアスの影響を受けている
- この汚染により、純粋な因果関係が歪む可能性がある
- **バイアス補正後能力**を用いて、より正確な因果推論を実施

#### **交絡因子の統制**
- **騎手・斤量・血統**等のバックドア要因は、複数の変数に同時に影響
- これらを統制しないと、偽の因果関係を検出する可能性がある
- 傾向スコア・IPW等の手法で統計的に調整

### **🧪 仮説検証での使用例**

| 仮説 | 使用する特徴量 | 統制する変数 |
|------|---------------|-------------|
| **H1: レース格→タイム** | `race_level`, `time_zscore` | `distance_category`, `馬場状態` |
| **H4: タイム→複勝率** | `time_zscore`, `is_placed` | `race_level`, `horse_ability` |
| **H5: タイムの媒介効果** | 全ての特徴量 | バックドア要因 |

---

## 🎯 分析での活用方法

### **1. 因果推論における目的変数・説明変数**

| 分析タイプ | 目的変数 | 主要説明変数 | 用途 |
|-----------|----------|-------------|------|
| **勝率分析** | `is_win` | `race_level`, `horse_ability` | レースレベル→勝率の因果効果 |
| **複勝率分析** | `is_placed` | `race_level`, `time_zscore` | レースレベル→複勝率の因果効果 |
| **タイム分析** | `time_zscore` | `race_level`, `track_bias` | レース格→タイムの因果効果 |
| **媒介分析** | `is_placed` | 媒介変数: `time_zscore` | タイムを通じた間接効果 |
| **比較分析** | `is_win`, `is_placed` | 全特徴量 | 勝利と複勝の効果差異比較 |

### **2. 主要特徴量を使った分析の考え方**

#### **📊 相関分析：「関係の強さ」を調べる**

**目的**: どの特徴量同士が強く関係しているかを数値で把握する

**具体的な分析**:
- **レースレベル vs 複勝率**: 格の高いレースほど複勝しにくいか？
- **馬能力 vs 走破タイム**: 能力の高い馬ほど速いタイムで走るか？
- **トラックバイアス vs 複勝率**: 有利な条件の馬ほど上位入線するか？

**距離別の分析も実施**:
- **スプリント**: 短距離でのレースレベルと複勝率の関係
- **マイル**: 中距離でのパターン
- **ステイヤー**: 長距離でのパターン

#### **🧪 仮説H1検証：「レース格が高いほど、タイムが速くなる」**

**分析の狙い**: G1レースの方が、本当に未勝利戦より速いタイムが出るのか？

**統制する要因**:
- **距離の違い**: 1200mと2400mでは当然タイムが違うので調整
- **馬場状態**: 良馬場と重馬場では走りやすさが違うので調整
- **競馬場の違い**: 東京と小倉では特性が違うので調整

**期待される結果**: 他の条件を同じにしても、やはりG1の方が速いタイムが出る

#### **🎯 仮説H4検証：「速いタイムで走ること自体が、複勝率を高める」**

**分析の狙い**: 「結局、速く走れる馬が勝つ」という当然の話を数値で確認

**統制する要因**:
- **レースレベル**: G1と未勝利戦では元々難易度が違うので調整
- **馬能力**: 元々強い馬は当然勝ちやすいので、その影響を除く
- **トラックバイアス**: 有利な条件で走った馬の影響を除く

**期待される結果**: 他の条件を同じにしても、速いタイムの馬ほど複勝率が高い

#### **🔄 仮説H5検証：「レースの格が複勝率に影響するのは、主にタイムを通してである」**

**分析の狙い**: G1で勝ちやすいのは、G1で速いタイムを出せるからなのか？それとも別の理由があるのか？

**媒介効果の分析**:
1. **直接効果**: レース格 → 複勝率（タイムとは無関係の影響）
2. **間接効果**: レース格 → タイム → 複勝率（タイムを通じた影響）
3. **総効果**: 直接効果 + 間接効果（全体の影響）

**具体例での理解**:
- **間接効果が大きい場合**: 「G1で勝ちやすいのは、速いタイムを出せるから」
- **直接効果が大きい場合**: 「G1には、タイム以外の『何か』が勝敗を左右する」

#### **💡 分析結果の解釈例**

**パターン1**: 間接効果90%、直接効果10%
- **解釈**: レースの格による勝率向上は、ほぼ全てタイムの向上で説明できる
- **結論**: 「強いレース = 速いタイム = 勝利」という単純な構造

**パターン2**: 間接効果50%、直接効果50%
- **解釈**: タイム以外にも、格の高いレースならではの要因がある
- **推測**: プレッシャー、展開の特殊性、出走馬の駆け引きなど

**パターン3**: 間接効果20%、直接効果80%
- **解釈**: レースの格は、タイムとは別のルートで勝敗に大きく影響
- **推測**: G1特有の「勝負根性」や「経験値」などが重要

### **3. バイアス補正での活用**

| バイアス要因 | is_win活用 | is_placed活用 |
|-------------|-----------|---------------|
| **トラックバイアス** | 勝率変化の測定 | 複勝率変化の測定 |
| **馬場状態** | 天候効果の定量化 | 安定性評価 |
| **枠順バイアス** | 内外枠効果測定 | 不利補正計算 |

---

## 📈 統計的特徴

### **理論的勝率・複勝率**

| レース規模 | 理論勝率 | 理論複勝率 | 実測との比較 |
|-----------|----------|-----------|-------------|
| **12頭立て** | 8.33% | 25.00% | 実測: 7.547%（勝率）、23.690%（複勝率） |
| **16頭立て** | 6.25% | 18.75% | 実際の頭数により変動 |
| **18頭立て** | 5.56% | 16.67% | 大規模レースでの特徴 |

### **競馬特有の特徴**

1. **除外馬の扱い**: 着順0（出走取消・競走除外）は`is_placed=True`
2. **同着の扱い**: 同着の場合、両馬とも該当フラグが立つ
3. **失格・降着**: 元着順ではなく、確定着順で判定

---

## 🔬 データ品質

### **完全性チェック**

```python
# 欠損値確認
print(f"is_win欠損値: {df['is_win'].isna().sum()}")
print(f"is_placed欠損値: {df['is_placed'].isna().sum()}")

# 論理整合性チェック
inconsistent = df[df['is_win'] & ~df['is_placed']]
print(f"論理エラー（勝利だが複勝でない）: {len(inconsistent)}")
```

### **バリデーション結果**

| チェック項目 | 結果 | 状態 |
|-------------|------|------|
| **欠損値** | 0件 | ✅ 正常 |
| **論理整合性** | 0件のエラー | ✅ 正常 |
| **データ型** | ブール値 | ✅ 正常 |
| **範囲** | True/False のみ | ✅ 正常 |

---

## 🔄 関連特徴量

### **派生特徴量**

| 特徴量名 | 関係 | 用途 |
|----------|------|------|
| `place_rate_binary` | `is_placed`の数値版 | 回帰分析用 |
| `win_rate_binary` | `is_win`の数値版 | 回帰分析用 |
| `jockey_place_rate` | 騎手の過去複勝率 | バックドア要因 |

### **集計用特徴量**

```python
# 騎手別集計例
jockey_stats = df.groupby('騎手名').agg({
    'is_win': ['count', 'sum', 'mean'],
    'is_placed': ['count', 'sum', 'mean']
}).round(3)
```

---

## ⚠️ 注意事項

### **データ利用時の留意点**

1. **時系列性**: 過去データでの学習、未来データでの予測
2. **季節性**: 時期によるレース特性の変化
3. **競馬場特性**: 場所による勝率・複勝率の違い
4. **レース格差**: G1とオープン特別では傾向が異なる

### **因果推論での考慮点**

1. **選択バイアス**: 強い馬ほど格上レースに出走
2. **時変交絡**: 馬の成長・衰退による能力変化
3. **SUTVA仮定**: 他馬の出走が結果に与える影響

---

## 📚 技術仕様

### **データ型と記憶域**

```python
# 主要特徴量のデータ型
df['is_win'].dtype              # bool
df['is_placed'].dtype           # bool
df['race_level'].dtype          # float64
df['time_zscore'].dtype         # float64
df['track_bias_total'].dtype    # float64
df['distance_category'].dtype   # category

# メモリ使用量（528,088レコード）
is_win_memory = df['is_win'].memory_usage(deep=True)              # 約528KB
is_placed_memory = df['is_placed'].memory_usage(deep=True)        # 約528KB
race_level_memory = df['race_level'].memory_usage(deep=True)      # 約4.2MB
time_features_memory = df[['time_zscore', 'speed_index', 
                          'time_ratio']].memory_usage(deep=True).sum()  # 約12.6MB
total_features_memory = df.memory_usage(deep=True).sum()         # 約580MB (137カラム)
```

### **パフォーマンス**

| 操作 | 処理時間（528K行） | 備考 |
|------|-------------------|------|
| **is_win/is_placed作成** | < 100ms | 着順データから直接生成 |
| **race_level計算** | < 2s | グレード判定・距離補正・正規化 |
| **タイム特徴量計算** | < 5s | 距離補正・Z-score・速度指標 |
| **track_bias計算** | < 1s | 脚質・枠順・馬場状態の統合 |
| **全特徴量エンジニアリング** | < 15s | 全137カラムの計算 |
| **相関分析** | < 2s | groupby・統計計算 |
| **回帰分析** | < 3s | scikit-learn使用 |
| **データ保存** | < 10s | 日付別CSV出力 |

### **計算方法の詳細**

#### **レースレベルの計算手順**
1. **グレード要素（60%）**: G1=9点, G2=8点, G3=7点... として基礎点を決定
2. **賞金要素（40%）**: 1着賞金の額に応じて0-10点で評価
3. **重み付け合算**: グレード要素×0.6 + 賞金要素×0.4
4. **距離補正**: 2000m前後なら×1.45, スプリントなら×0.85 など
5. **最終正規化**: 全体を0-10の範囲に収まるよう調整

#### **タイムz-scoreの計算手順**
1. **同一条件のグループ分け**: 距離・馬場状態・競馬場が同じレースをまとめる
2. **グループ内平均の計算**: そのグループの平均タイムを算出
3. **グループ内標準偏差の計算**: そのグループでのタイムのバラつきを算出
4. **z-score算出**: (そのレースのタイム - グループ平均) ÷ グループ標準偏差
5. **解釈**: マイナス値ほど速い、プラス値ほど遅い

#### **トラックバイアスの計算手順**
1. **脚質バイアス（40%）**: その日の逃げ・先行・差し・追込の勝率を比較
2. **枠順バイアス（30%）**: その日の内枠・外枠の勝率を比較
3. **馬場状態バイアス（30%）**: 良・稍重・重・不良での走りやすさを評価
4. **重み付け合算**: 各要素に重みを掛けて足し合わせ
5. **個別適用**: 各馬の脚質・枠順・適性に応じて、そのバイアス値を適用

---

## 🎯 今後の活用

### **Phase 1以降での利用**

1. **仮説検証**: H1, H4, H5仮説の目的変数
2. **因果効果測定**: ATE, ATT, ATCの算出
3. **傾向スコア**: 共変量バランシング
4. **機械学習**: 予測モデルの教師データ

### **実用化への展開**

1. **リアルタイム予測**: 新レースでの勝率・複勝率予測
2. **投資戦略**: ROI分析での収益計算
3. **馬券購入支援**: 期待値ベース意思決定

---

## 📞 問い合わせ

### **📁 実装場所とファイル構成**

#### **データ処理スクリプト**
| ファイル | 役割 | 主要機能 |
|----------|------|----------|
| `process_race_data.py` | エントリーポイント | 第0段階データ整備の統合実行 |
| `horse_racing/data/processors/race_level_processor.py` | 特徴量エンジニアリング | 137カラムの包括的特徴量作成 |
| `analyze_race_level.py` | 分析実行 | 仮説H1, H4等の検証・可視化 |

#### **実行コマンド**
```bash
# 第0段階: データ整備（特徴量エンジニアリング）
python process_race_data.py --レースレベル分析

# Phase 1: 基礎分析（仮説H1検証等）
python analyze_race_level.py export/race_level_analysis --enable-time-analysis

# Phase 1: 3年間隔分析
python analyze_race_level.py export/race_level_analysis --three-year-periods --enable-time-analysis
```

#### **出力ファイル構成**
```
export/race_level_analysis/
├── SED230326_race_level_analysis.csv    # 日付別分析データ
├── SED230327_race_level_analysis.csv
├── ...
├── feature_summary.json                 # 特徴量サマリー
└── [analyze_race_level.py実行後]
    ├── レースレベル分析_相関分析結果.png
    ├── レースレベル分析_箱ひげ図.png
    ├── レースレベル分析_散布図.png
    ├── 仮説H1検証結果.png               # RunningTime分析
    └── 仮説H4検証結果.png               # 複勝率分析
```

#### **主要クラス・関数**
| クラス/関数 | ファイル | 機能 |
|------------|----------|------|
| `RaceLevelFeatureProcessor` | race_level_processor.py | 特徴量エンジニアリング |
| `RaceLevelAnalyzer` | race_level_analyzer.py | 相関分析・仮説検証 |
| `verify_hypothesis_h1()` | race_level_analyzer.py | 仮説H1検証（レース格→タイム） |
| `verify_hypothesis_h4()` | race_level_analyzer.py | 仮説H4検証（タイム→複勝率） |
| `calculate_running_time_features()` | race_level_analyzer.py | タイム特徴量計算 |

#### **設定ファイル**
| 項目 | 設定値 | 説明 |
|------|--------|------|
| **GRADE_LEVELS** | G1=9.0, G2=8.0, ... | グレード定義とベースレベル |
| **LEVEL_WEIGHTS** | grade=0.6, prize=0.4 | レースレベル計算重み |
| **距離補正係数** | スプリント=0.85, マイル=1.0, ... | 距離帯による補正値 |

---

**最終更新**: 2025年3月29日  
**データバージョン**: 第0段階（Phase 0）レースレベル分析用 