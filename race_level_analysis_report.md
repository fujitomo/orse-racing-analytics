# 競馬データ分析における特徴量エンジニアリングと時系列分析：`HorseRaceLevel`指標の構築と検証

## はじめに：本稿の目的
本稿は、データ分析の実務未経験者が自身の課題解決能力・技術力・論理的考察力を実証するために作成した技術ポートフォリオである。

- **対象読者**: データ分析分野における実務経験者

## 第1部：ドメイン知識と分析課題の定式化

### 1.1 問題設定：競走馬の実績評価における「勝利の価値」の定量化

#### 1.1.1 従来手法の問題点

競走馬の能力評価において、勝利数や着順といった**実績**を単純集計する従来手法には**3つの分析上の問題**が存在する：

1. **レース質の差異無視**: 競争レベルの異なるレースを同等に扱う。例：「未勝利戦1着 vs G1の3着」
2. **説明変数の欠落**: グレード、賞金額、距離等の重要情報を無視し、予測精度が低下する。
3. **集計方法の単純性**: 単純カウント（勝利数、着順数）のみで、成績の質的重みを考慮しない。

#### 1.1.2 分析目標

本分析の主目的は、各競走馬がキャリアを通じて経験してきた**競走環境の厳しさを客観的かつ定量的に評価する合成特徴量**を構築し、その有効性を検証することである。

### 1.2. 解決アプローチ：合成特徴量 `HorseRaceLevel` の設計
この課題を解決するため、本データ分析では以下の2段階のプロセスを通じて各馬の実績を評価する合成特徴量 `HorseRaceLevel` を設計・検証する。

1.  **Step 1: 個別レースの「質」の定量化 (`RacePoint`)**
    
    個々のレースが持つ「質」を以下の3要素から総合評価し、単一の数値（`RacePoint`）に変換する：
    - **レースの格式**：G1からオープン特別までの階層評価
    - **賞金額**：レース重要度を反映する客観的指標
    - **レース場所**：レース場所のレベル値
    - **距離**：競争レベルに応じた距離別価値補正
    
    各要素の重み付けは、複勝率との相関分析に基づいて決定される。

2.  **Step 2: 馬ごとの実績集約 (`HorseRaceLevel`)**
    各馬の全出走履歴から`RacePoint`を集計し、平均値（`AvgRaceLevel`）と最大値（`MaxRaceLevel`）を算出する。

**本分析の検証目標**: 上記のように設計された`HorseRaceLevel`が、馬の競走能力（本分析では「複勝率」を代理変数とする）と統計的に有意な正の相関関係を持つか否かを検証することである。

## 第2部: 使用データと前処理

本データ分析の再現性と透明性を担保するため、使用データとその前処理について記述する。

### 2.1. 使用データ
本データ分析では、JRDBが提供する過去の競馬データ（有料）を使用する。
JRDBのデータは、レース結果だけでなく、馬の能力指数（IDM）やトラックバイアスなど多角的な情報を含んでおり、本分析の目的を達成する上で有用である。

- **データソース**: JRDB 成績データ（SED,SRB,BAC）
- **対象期間**: 2018年1月1日〜2023年12月31日
- **データ概要**:
    - **レース情報**: 開催日、競馬場、グレード(G1,G2等)、賞金、レース番号、距離、馬場状態、天候など
    - **競走馬情報**: 馬名、血統登録番号、騎手、斤量、馬体重など
    - **成績情報**: 着順、走破タイム、通過順、単勝オッズ、人気など
    - **JRDB独自指標**: IDM（能力指数）、ペース指数、上がり指数など

### 2.2. データの前処理
取得した生データは、後続の分析工程で利用可能な形式にするため、以下の前処理を適用した。これらの処理は、`process_race_data.py`によって実行され、分析の土台となるデータセットを生成する。

1.  **データクリーニングと型変換**:
    - **戦略的欠損値処理**:
        - **重要列の除外**: 分析の重要な特徴量となる`着順`, `タイム`, `距離`, `馬名`, `IDM`に欠損値を含むレコードは、分析の妥当性を損なうため、対象から除外した。
    - **データ型変換**: 各列を分析に適したデータ型（例: `タイム`→浮動小数点数, `距離`→整数）へ変換した。

2.  **特徴量エンジニアリングと数値化**:
    `RacePoint`の計算に必要な特徴量を、以下の通り生成・数値化した。
    - **`グレード`の推定と数値化**:
        - **課題**: `グレード`列には一部欠損が存在するが、これはレースの「質」を測る上で極めて重要な特徴量であるため、単純な補完ではなく、他の特徴量からその値を推定するアプローチを採用した。
        - **推定ロジック**: `process_race_data.py`内の`MissingValueHandler`において、以下のドメイン知識に基づく階層的ロジックで`グレード`を推定した。
            ・**賞金からの推定**: `本賞金`を実際の競馬界基準で階層分類（G1: 1.5億円以上、G2: 6千万円以上、G3: 4千万円以上、重賞: 1.5千万円以上、特別: 500万円以上）。
        - **最終処理**: このように推定・補完された後、`G1=1`, `G2=2`のように順序尺度として数値化し、モデルの入力特徴量とした。また、検証容易性のために、数値に対応する`Ｇ１`などの文字列を格納した`グレード名`列も別途追加した。
    - **`賞金`**: レースの重要度を示す客観的指標として「本賞金」を数値データのまま利用した。

3.  **分析用データセットの生成**:
    上記の前処理を経たデータは、`export/dataset/`ディレクトリにCSVファイルとして保存される。

## 第3部：分析設計と技術的アプローチ（`analyze_race_level.py` 設計図）

### 3.1. 特徴量エンジニアリング：`HorseRaceLevel` の算出ロジック
本分析の対象である`HorseRaceLevel`は、以下の2ステップで算出される。
そのロジックの背景にあるドメイン知識と統計的判断を以下に詳述する。

#### **Step 1: 個別レースの「質」の定量化 (`RacePoint`)**
各レースに与えられる`RacePoint`は、以下の要素を重み付き合計して算出される。

`RacePoint = (基礎点) * (補正係数)`

**1. 基礎点：レースの基本的な「格」**
`基礎点 = (グレードレベル * w₁) + (レース場所レベル * w₂) + (距離レベル * w₃)`

ここで、w₁, w₂, w₃は各
-   **`グ要素と複勝率の相関強度に基づいて決定される重み
レードレベル`**:
    -   **定義**: G1から未勝利戦までの公式格付けを、`G1=9`から始まる等間隔の順序尺度に変換したものである。
    -   **採用理由**: レースの公式な権威性を直接的にモデルへ導入するため、基本要素として採用した。

-   **`レース場所レベル`**:
    -   **定義**: 競馬場を格式と重要度に基づいて階層分類し、数値化した指標である。
    -   **統計的妥当性**: 東京・中山・阪神・京都等の中央開催主要4場は最高レベル、その他中央開催場は中レベル、地方開催場は基本レベルとして体系化。
    -   **採用理由**: 同一グレードでも開催場所により競争レベルが異なるため、競馬場の格式を数値化してレース価値の精度を向上させる目的で採用した。

-   **`距離レベル`**:
    -   **定義**: レース距離を5つのカテゴリー（スプリント/マイル/中距離/中長距離/長距離）に分類し、競争レベルに応じた価値係数を適用した指標。
    -   **統計的妥当性**: 距離と競争レベルの関係は非線形であり、2000m前後で最高値を取る山型分布を示す。
    -   **採用理由**: 同一格式・同一賞金でも距離により競争価値が変動するため、この影響を数値化して基礎点に組み込む。

-   **重み決定プロセス**:
    -   **個別相関分析**: 各要素（グレード場所、距離）を個別に複勝率と相関分析
    -   **相関強度ベース重み**: r²（決定係数）を用いた正規化により各要素の重みを決定
    -   **検証**: クロスバリデーションとドメイン知識による妥当性確認
        - **クロスバリデーション**: 6年間のデータ（2018-2023年）を時系列で5分割し、各分割をテスト用に順次使用。例：分割1（2018年）をテスト用に残し、残り4年分で重み計算→テスト用で性能評価、これを5回繰り返す。各回で算出される重みの変動幅（標準偏差）が小さければ安定性を確認。
        - **ドメイン知識確認**: 統計的に算出された重みが競馬の専門知識と整合するかを検証。グレード > 場所 > 距離の重要度順序など、業界常識との一致を確認する。

**2. 補正係数：ドメイン知識に基づく価値の調整**

-   **`距離ボーナス`**:
    -   **定義**: 特定の距離カテゴリのレースに対し、補正係数を乗算する。
    -   **パラメータ決定**: 「クラシック路線」と呼ばれる2000m前後のレースは競争が激化するというドメイン知識をモデルに組み込むため、補正係数を1.0～2.0の範囲で0.05刻みで変化させ、各係数での複勝率との相関を測定。グリッドサーチの結果、1.35倍で相関が最大となったため採用。これは日本ダービー（2400m）、皐月賞（2000m）等の主要G1レースが集中する距離帯の競争価値を適切に反映した値である。

-   **`交互作用ボーナス`**:
    -   **定義**: 特定の「グレード」と「距離」の組み合わせに対し、交互作用を考慮したボーナス係数を適用する。
    
    | グレード     | 距離カテゴリ   | ボーナス係数 | 根拠                                                                 |
    | :----------- | :------------- | :----------- | :------------------------------------------------------------------- |
    | G1, G2, G3   | 1800m - 2400m  | 1.15倍       | クラシック路線や主要G1レースが集中する、最も競争が激しい区間であるため。 |
    
    **係数決定の根拠**:
    - **1.15倍の選択**: 距離ボーナス（1.35倍）との重複適用を考慮し、過度な重み付けを避けるため1.15倍に設定。グレード単体での重みが既に高いため、適度な上乗せに留める。
    - **G3より低いグレードを除外**: 重賞以下のグレードでは1800m-2400mの距離帯でも競争レベルにばらつきが大きく、一律のボーナス適用が不適切。G1-G3のみが安定した高競争レベルを保持するため対象を限定。

#### **Step 2: 馬ごとの実績集約 (`HorseRaceLevel`)**
上記の`RacePoint`を基に、各馬に対し2種類の`HorseRaceLevel`を算出する。

-   **`AvgRaceLevel` (平均レースレベル)**:
    -   **算出方法**: 当該馬が過去に出走した全レースの`RacePoint`の平均値。
    -   **分析上の意味**: キャリアを通じたパフォーマンスの一貫性や、平均的な活動ステージのレベルを示す。

-   **`MaxRaceLevel` (最高レースレベル)**:
    -   **算出方法**: 当該馬が過去に出走した全レースの`RacePoint`の最大値。
    -   **分析上の意味**: キャリアにおける最大到達能力（ポテンシャル）やピークパフォーマンスを示す。

### 3.2. 検証する作業仮説
設計した合成特徴量 `HorseRaceLevel` が競走馬の能力を定量化する指標として有効に機能するかを検証するため、以下の3つの作業仮説を設定する。

#### **仮説1: `HorseRaceLevel`は競走能力の予測に有効である。**
-   **帰無仮説 (H₀)**: `HorseRaceLevel`と複勝率の相関係数 ρ は0である (ρ = 0)。
-   **対立仮説 (H₁)**: `HorseRaceLevel`と複勝率の間には、統計的に有意な正の相関関係が存在する (ρ > 0)。
-   **本仮説検証の意義**:
    1.  競馬のデータ分析において、過去の競走履歴から将来のパフォーマンスを予測することは最重要な内容。
    2.  `HorseRaceLevel`が有効であれば、勝利数や着順といった単純な実績指標よりも高次元な能力評価が可能となる。
    3.  本特徴量は、競馬予測サービスにおける精度向上や、データプロダクトとしての商業的価値に寄与する可能性がある。
-   **検証方法**:
    -   **説明変数**: `AvgRaceLevel`, `MaxRaceLevel`
    -   **目的変数**: `place_rate` (複勝率)
        - **選定理由**: 馬の安定した競争力を測るため「複勝率」を目的変数として採用した。走破タイムは馬場状態・天候・ペース等の外的要因に左右されるが、複勝率は競争相手との相対的な強さを表すため環境要因の影響を受けにくい。また、勝率（1着）は競走馬1頭当たり年数回程度と稀な現象だが、複勝率（3着以内）は約3倍の頻度で発生するため、統計分析に必要な十分なデータ量を確保できる。
    -   **分析手法**: 散布図による可視化、相関係数の算出、および統計的有意性検定（p < 0.05）。

#### **仮説2: 平均レベルと最高レベルでは、予測力に差がある。**
-   **帰無仮説 (H₀)**: `AvgRaceLevel`と`MaxRaceLevel`の複勝率に対する予測力は等しい。
-   **対立仮説 (H₁)**: いずれか一方の指標が、より強い予測力を持つ。
-   **本仮説検証の意義**:
    1.  実務応用上、予測性能と計算コストのバランスを考慮し、最も寄与度の高い指標を選択することが求められる。
    2.  両指標の予測寄与度を比較することで、「平均的な能力」と「最大能力」のどちらが将来の成績と強く関連するかを評価し、予測モデルの戦略を決定できる。
-   **検証方法**:
    -   **比較対象**: `AvgRaceLevel`と`MaxRaceLevel`それぞれの相関係数。
    -   **評価基準**: 相関の強さ、決定係数（R²）、解釈性。

#### **仮説3: この分析手法は、異なる時期のデータでも再現性がある。**
-   **帰無仮説 (H₀)**: 異なるデータ期間において、`HorseRaceLevel`の有効性は再現されない。
-   **対立仮説 (H₁)**: 複数のデータ期間で、一貫して`HorseRaceLevel`と複勝率の正の相関が観測される。
-   **本仮説検証の意義**:
    1.  構築した指標の有効性が特定の期間に限定されず、時系列的に安定していることを示すことは、その指標の普遍性と信頼性を担保する上で不可欠である。
    2.  時間的普遍性を欠く指標は外的要因の変化に脆弱であり、実務的な応用価値が低い。
    3.  指標の有効性が時系列で安定していることを確認できれば、これを組み込んだ持続可能な予測モデルの構築が可能となる。
-   **検証方法**:
    -   **分析対象**: 3年間隔でのサブピリオド分析。
    -   **評価基準**: 各期間で算出された相関係数の一貫性。
    -   **実務への応用**: 結果の安定性に基づき、本指標の実用化の可否を判断する。

## 第4部：実験計画と検証戦略

### 4.1 実験設計の概要

本分析の信頼性と客観性を担保するため、ランダム化と層別化を組み込んだ実験計画を策定する。これにより、選択バイアスの除去と結果の一般化可能性を向上させる。

#### 4.1.1 実験の全体設計

**研究目的**: `HorseRaceLevel`が従来の単純集計手法（勝率・複勝率）よりも優れた競走能力予測指標であることを統計的に実証する。

**比較対象**:
- **提案手法**: `AvgRaceLevel`, `MaxRaceLevel`
- **従来手法**: 単純勝率、単純複勝率、勝利数
- **評価指標**: 複勝率との相関係数（Pearson, Spearman）

### 4.2 層別化によるバイアス制御

競馬データ特有の偏りを除去するため、以下の3軸による層別化を実施する。

#### 4.2.1 層別化の設計

**軸1: 馬齢層**
- **2歳馬**: キャリア初期、成長途上の評価
- **3歳馬**: クラシック世代、能力が確立される時期  
- **4歳以上馬**: 成熟馬、安定した能力発揮期

**軸2: 競走経験層**
- **少経験馬**: 1-5戦（キャリア初期）
- **中経験馬**: 6-15戦（能力評価が安定化）
- **多経験馬**: 16戦以上（十分な実績蓄積）

**軸3: 主戦距離層**
- **短距離専門**: 主要出走距離 ≤ 1400m
- **マイル専門**: 主要出走距離 1401-1800m  
- **中長距離専門**: 主要出走距離 ≥ 1801m

#### 4.2.2 層別化の統計的根拠

各層の設定は、競馬のドメイン知識と統計的考慮に基づく：

1. **馬齢による成長曲線**: 馬の能力発達パターンが年齢により異なる
2. **経験値による学習効果**: 出走回数と安定性の関係性
3. **距離適性による専門化**: 距離特性が能力評価に与える影響

### 4.3 ランダムサンプリング手順

#### 4.3.1 サンプリング戦略

**Step 1: 層別母集団の構築**

馬齢・競走経験・主戦距離の3軸による層別化を行い、各層の母集団サイズを算出する。統計的検出力を確保するため、各層から最低100頭のサンプルを抽出する必要がある。

**Step 2: 無作為抽出**

実験の再現性を担保するため、乱数シード値を固定した上で、各層から統計的に有意な分析を行うのに十分なサンプル数（最低100頭）を無作為に抽出する。抽出されたサンプルが母集団の特性を適切に代表しているかを統計的に検証し、偏りがないことを確認する。

**Step 3: 時期別分割**
- **訓練期間**: 2018-2020年（パラメータ決定用）
- **検証期間**: 2021-2023年（汎化性能評価用）
- 各期間から均等に抽出し、季節偏差を除去

#### 4.3.2 代表性の担保

**バランス確保**:
- 各層のサンプル数を全体の競走馬データにおける実際の割合と同じになるよう調整する。例：全競走馬のうち3歳馬が30%を占める場合、サンプルでも3歳馬を30%とする。

**交絡因子の制御**:
- 開催場による地域特性の均等化
- レース条件（トラックバイアス、血統、天候、騎手、調教師等）の偏りチェック
　TODO：時間があれば、これらの因子を層別化に加える。現状は保留。

### 4.4 統計的検証プロセス

#### 4.4.1 仮説検定の設計

第3部で設定した作業仮説を、層別化された各グループで個別に検証する。

**層別仮説**:
各層において第3部の仮説を個別に検証し、効果の一貫性を確認

**有意水準**: α = 0.05（Bonferroni補正適用時: α' = 0.05/層数）
    - **α = 0.05の意味**: 偶然でこの結果が出る確率が5%以下なら「統計的に意味がある」と判定する基準
    - **Bonferroni補正の必要性**: 複数の層で同時に検定すると、偶然有意になる確率が増加するため、より厳しい基準（有意水準を層数で割る）を適用して誤判定を防ぐ
    - **具体例**: 3つの馬齢層で分析する場合、α' = 0.05/3 = 0.0167となり、各層でp値が1.67%未満でないと有意と認めない

#### 4.4.2 効果量の評価

**相関係数の解釈基準** (Cohen, 1988):
- 小効果: |r| = 0.1
- 中効果: |r| = 0.3  
- 大効果: |r| = 0.55

**比較評価**:
提案手法と従来手法の相関係数差を効果量として評価

### 4.5 検証手順の実装

#### 4.5.1 段階的検証プロセス

**Phase 1: 層別内検証**

層別化された各グループ（馬齢・競走経験・主戦距離別）において、個別に統計分析を実行する。
具体的には、各層のHorseRaceLevelと複勝率の相関係数を算出し、統計的検定によりp値を求める。さらに各層のサンプル数も記録し、層別の分析結果を体系的に整理・比較する。

**Phase 2: 層間比較**
- 各層での効果サイズを比較
- 層による効果の異質性を検定（Q統計量）

**具体例**:
```
各グループの効果比較：

2歳馬: HorseRaceLevelと複勝率の関係は「弱い」
3歳馬: HorseRaceLevelと複勝率の関係は「中程度」  
4歳以上: HorseRaceLevelと複勝率の関係は「強い」

Q統計量による判定：
→ 「この3つのグループの効果の違いは偶然ではない」
→ つまり、馬の年齢によって本当にHorseRaceLevelの効きやすさが違う

実用的な意味：
- 2歳馬では参考程度
- 3歳馬では予測に使える
- 4歳以上では信頼性の高い予測が可能
```

**Phase 3: 統合分析**
- 各層の分析結果をまとめて、全体的な効果の大きさを算出
- 層間の違いを考慮しながら、統計的に適切な方法で結果を統合

**具体例**:
```
各馬齢グループで調べた結果：

2歳馬グループ：
HorseRaceLevelが高い馬ほど複勝率が良い傾向はあるが、関係は弱め

3歳馬グループ：
HorseRaceLevelが高い馬ほど複勝率が良い傾向がそこそこ見られる

4歳以上グループ：
HorseRaceLevelが高い馬ほど複勝率が明らかに良い

統合した結論：
→ HorseRaceLevelは競走馬の複勝率予測に使える指標
→ ただし年齢が上がるほど効果が大きくなる
→ 若い馬より成熟した馬でより信頼できる予測ができる
```

### 4.6 実験計画の意義と限界

#### 4.6.1 本実験設計の強み

1. **客観性の担保**: ランダム化により研究者バイアスを除去
2. **一般化可能性**: 層別化により様々な条件での有効性を検証 
3. **実務適用性**: 条件別の有効性が明確になり実装方針が決定可

#### 4.6.2 限界と今後の課題

**この研究の限界**:
- 過去のデータを調べただけなので、「HorseRaceLevelが高いから複勝率が良い」と断言できない
- 調べていない他の要因（調教師の腕、厩舎の環境など）が影響している可能性がある

**適用範囲の限界**:
- 日本の平地競走のみの分析なので、海外競馬や障害競走で使えるかは不明
- 2026年以降の競馬で同じ効果があるかは確認が必要

**今後の改善案**:
- より長い期間のデータで安定性を確認
- 複勝率以外（勝率や収益性）でも効果があるか調査
- 機械学習等と組み合わせてさらに精度向上を目指す

## 第5部：分析結果と考察
### 5.1. 相関分析：`HorseRaceLevel`と競走能力の関連性
### 5.2. 時系列分析：`HorseRaceLevel`の有効性は時代と共に変化するか
### 5.3. 今後の展望

## 結論：本ポートフォリオで示した能力 