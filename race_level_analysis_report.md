# 競走馬の複勝率に対する合成特徴量HorseRaceLevelの有効性評価: 相関分析と層別検証

### 要約（Abstract）
TODO：完成後に記載予定

### キーワード
競馬分析, HorseRaceLevel, 合成特徴量, 複勝率, 相関分析, 仮説検定, 多重比較補正, 層別分析, 再現可能研究

## 目次

### 第0部：本レポートを理解するための前提知識
- 0.1 用語集とキーワード解説
- 0.2 競馬業界の基礎知識
- 0.3 本分析の学習価値と実務への応用
- 0.4 再現環境・倫理・DSSマインドセット

### 第1部：問題認識と分析戦略
- 1.1 現状課題の特定と分析目標の設定
- 1.2 ドメイン課題の発見プロセス
- 1.3 データサイエンス的アプローチの選択根拠

### 第2部：使用データと前処理
- 2.1 使用データ
- 2.2 データの前処理
- 2.3 再現環境と実行手順

### 第3部：分析設計と技術的アプローチ（設計図）
- 3.1 特徴量エンジニアリング：`HorseRaceLevel` の算出ロジック
- 3.2 検証する作業仮説

### 第4部：実験計画と検証戦略
- 4.1 実験設計の概要
- 4.2 層別化によるバイアス制御
- 4.3 ランダムサンプリング手順
- 4.4 統計的検証プロセス
- 4.5 検証手順の実装
- 4.6 実験計画の意義と限界

### 第5部：分析結果と考察
- 5.1 層別分析結果
- 5.2 仮説検証（層別結果を基に）
- 5.3 統合分析と総合評価

---

## 第0部：本レポートを理解するための前提知識

### 0.1 用語集とキーワード解説

#### 0.1.1 競馬ドメイン用語

**グレード制度**
: 中央競馬における公式なレース格付けシステム。G1（最高格）からオープン特別、条件戦、未勝利戦まで階層化されている。

**複勝率（Place Rate）**
: 競走馬が3着以内に入る確率。本分析では馬の安定した競争力を測る指標として採用。勝率（1着率）より頻度が高く、統計分析に適したサンプル数を確保可能。

**IDM（Index of Ability）**
: JRDBが独自に算出する競走馬の能力指数。過去の成績、血統、調教内容等を総合評価した数値。

**クラシック路線**
: 3歳馬の最重要競走群。皐月賞（2000m）→日本ダービー（2400m）→菊花賞（3000m）の三冠レースを中心とした一連の競走。

**ステークス競走**
: 重賞レースの正式名称。G1、G2、G3、重賞の総称。

#### 0.1.2 分析手法用語

**仮説検定**
: 母集団に関する仮説が正しいかを標本データで統計的に判定する手法。本分析では「HorseRaceLevelと複勝率に相関がある」という仮説を検証。

### 0.2 競馬業界の基礎知識

#### 0.2.1 競馬業界の構造

**中央競馬と地方競馬**
- **中央競馬**: JRA（日本中央競馬会）が主催。東京、中山、阪神、京都等の主要競馬場で開催。レースレベルが高い。
- **地方競馬**: 各地方自治体が主催。門別、大井、川崎等で開催。中央競馬と比較して競争レベルが劣るとされる。

**競馬場の格式**
- **最高格**: 東京、中山、阪神、京都（主要G1レース開催場）
- **準主要格**: 新潟、小倉、函館、福島、中京（夏季・地方開催中心）

#### 0.2.2 レースシステム

**出走条件による分類**
1. **グレード競走**: G1、G2、G3（国際基準の格付け）
2. **重賞競走**: リステッド競走（グレード以外の重賞）
3. **オープン特別**: 賞金上限なしの一般レース
4. **条件戦**: 勝利数や獲得賞金による出走制限レース
5. **未勝利戦**: 未勝利馬のみが出走可能

**距離による分類**
- **短距離（スプリント）**: 1000m-1400m
- **マイル**: 1401m-1800m 
- **中距離**: 1801m-2200m
- **中長距離**: 2201m-2600m
- **長距離**: 2601m以上

#### 0.2.3 競走馬のライフサイクル

**年齢による特徴**
- **2歳**: デビュー年。能力未確定、成長途上
- **3歳**: クラシック世代。能力が確立される最重要年
- **4歳以上**: 成熟期。安定した能力発揮、実績蓄積期

**キャリア段階**
- **新馬戦**: デビュー戦
- **未勝利戦**: 勝利を目指す段階
- **条件戦**: 勝利条件をクリアした馬の段階  
- **オープン・重賞**: トップレベルでの競走


## 第1部：問題認識と分析について

### 1.1 現状課題の特定と分析目標の設定

#### 1.1.1 分析目標の明確化

**主目標**：
各競走馬がキャリアを通じて経験してきた **「競走環境の厳しさ」を客観的かつ定量的に評価する合成特徴量** を構築し、その予測有効性を統計的に検証すること。

**副目標**：
1. 従来手法より高い予測精度を実現する特徴量の開発
2. 実務応用可能な馬券予測システムの基盤構築
**成功基準**：
- 合成特徴量と複勝率の間に統計的有意な正の相関（p < 0.05）を確認
- 複数年度のデータで一貫した効果を確認（時系列安定性）
- 副目標については、今回の分析の制約では達成できないため副目標として設定。

### 1.2 ドメイン課題の発見プロセス

#### 1.2.1 分析対象のドメイン知識
中央競馬では、レースの格式を表すグレード制度が確立されている。

**競馬の業界常識**：
- 「G1で好走した馬は、どんなレースでも信頼できる」
- 「同じ勝利でもレースのレベルにより価値が全く異なる」
- 「特定の距離、レース場所や賞金額の高いレースほど競争が激しい」

**データサイエンス視点の疑問**：
これらの「常識」は本当にデータで裏付けられるのか？
→ **検証可能な形に変換する必要性**

#### 1.2.2 データによるドメイン知識の検証方針

**段階的検証アプローチ**：
本分析では、ドメイン知識の妥当性確認と主要仮説検証を段階的に実施する。

**第1段階：指標の構成要素となる個別要素の有効性検証**
※3.1　**重み決定プロセス**　**個別相関分析**で実施。
- 複勝したレースグレード（欠損値は賞金額で補完）ポイントと複勝率の相関検証
- 複勝したレース距離レベルポイントと複勝率の相関検証
- 複勝した開催場所による競争レベル差異の確認

**第2段階：主要仮説の検証**（第3部で詳述）
1. 合成特徴量**`HorseRaceLevel`の予測有効性**：構築した合成特徴量と競走能力（複勝率）の相関関係
2. **指標の比較評価**：平均レベル vs 最高レベルの予測力比較
3. **時系列安定性**：異なる期間データでの再現性確認

**検証手法**：
- 相関分析、回帰分析による定量的評価
- 層別分析による頑健性確認
- クロスバリデーションによる汎化性能検証

### 1.3 データサイエンス的アプローチの選択根拠

#### 1.3.1 手法選択の論理的判断

**特徴量エンジニアリング・アプローチの採用理由**：

1. **問題の本質に適合**：
   - 課題：「レースの価値」という抽象概念の定量化
   - 解決策：複数の数値情報を統合して新しい指標を構築（合成特徴量）
   - 根拠：単一特徴量では表現できない複合的な情報を合成特徴量で表現

2. **ドメイン知識との親和性**：
   - 競馬の専門知識を数学的に表現可能
   - 業界の評価基準（グレード、賞金、レース距離、開催場所）を定量化に活用
   - 解釈可能性の高いモデル構築が可能

3. **実装・運用の現実性**：
   - 複雑な機械学習モデルより実装コストが低い
   - 結果の説明が容易で、実務者の理解を得やすい
   - 計算負荷が軽く、リアルタイム予測に適用可能

#### 1.3.2 分析戦略の設計原則

**原則1: 段階的構築**
- Step 1: 個別レースの価値定量化 → `RacePoint`
- Step 2: 馬ごとの実績統合 → `HorseRaceLevel`
- 各段階で検証を行い、論理的整合性を確保

**原則2: 統計的厳密性**
- 相関分析による客観的評価
- 仮説検定による偶然性の排除
- 層別分析による頑健性確認

**原則3: 実務適用性**
- 入手可能なデータのみを使用
- 計算が透明で追跡可能
- 継続的な改善が可能な設計

#### 1.3.3 代替手法との比較と選択理由

**検討した他のアプローチ**：

1. **機械学習による直接予測**
   - 利点：高い予測精度の可能性
   - 欠点：ブラックボックス化、解釈困難
   - 不採用理由：学習過程の論理性を示せない

2. **既存指標の単純利用**
   - 利点：実装が簡単
   - 欠点：前述の問題点を解決できない
   - 不採用理由：改善効果が期待できない

3. **複雑な統計モデル**
   - 利点：統計的厳密性
   - 欠点：実装コスト高、解釈困難
   - 不採用理由：実務適用性に課題

**本アプローチの優位性**：
ドメイン知識・統計的厳密性・実務適用性の3要素を最適バランスで統合

## 第2部: 使用データと前処理

本データ分析の再現性と透明性を担保するため、使用データとその前処理について記述する。

### 2.1. 使用データ
本データ分析では、JRDBが提供する過去の競馬データ（有料）を使用する。
JRDBのデータは、レース結果だけでなく、馬の能力指数（IDM）やトラックバイアスなど多角的な情報を含んでおり、本分析の目的を達成する上で有用である。

- **データソース**: JRDB 成績データ（SED,SRB,BAC）　TODO：データソースの説明を追加
- **対象期間**: 2018年1月1日〜2023年12月31日
- **データ概要**:
    - **レース情報**: 開催日、競馬場、グレード(G1,G2等)、賞金、レース番号、距離、馬場状態、天候など
    - **競走馬情報**: 馬名、血統登録番号、騎手、斤量、馬体重など
    - **成績情報**: 着順、走破タイム、通過順、単勝オッズ、人気など
    - **JRDB独自指標**: IDM（能力指数）、ペース指数、上がり指数など

### 2.2. データの前処理
取得した生データは、後続の分析工程で利用可能な形式にするため、以下の前処理を適用した。これらの処理は、`process_race_data.py`によって実行され、分析の土台となるデータセットを生成する。

1.  **データクリーニングと型変換**:
    - **欠損値処理**:
        - **重要列の除外**: 分析の重要な特徴量となる`着順`, `タイム`, `距離`, `馬名`, `IDM`に欠損値を含むレコードは、分析の妥当性を損なうため、対象から除外した。
    - **データ型変換**: 各列を分析に適したデータ型（例: `タイム`→浮動小数点数, `距離`→整数）へ変換した。

2.  **特徴量エンジニアリングと数値化**:
    `RacePoint`の計算に必要な特徴量を、以下の通り生成・数値化した。
    - **`グレード`の推定と数値化**:
        - **課題**: `グレード`列には一部欠損が存在するが、これはレースの「質」を測る上で極めて重要な特徴量であるため、単純な補完ではなく、他の特徴量からその値を推定するアプローチを採用した。
        - **推定ロジック**: `process_race_data.py`内の`MissingValueHandler`において、以下のドメイン知識に基づく階層的ロジックで`グレード`を推定した。
            ・**賞金からの推定**: `本賞金`を実際の競馬界基準で階層分類（G1: 1.5億円以上、G2: 6千万円以上、G3: 4千万円以上、重賞: 1.5千万円以上、特別: 500万円以上）。
        - **最終処理**: このように推定・補完された後、`G1=1`, `G2=2`のように順序尺度として数値化し、モデルの入力特徴量とした。また、検証容易性のために、数値に対応する`Ｇ１`などの文字列を格納した`グレード名`列も別途追加した。
    - **`賞金`**: レースの重要度を示す客観的指標として「本賞金」を数値データのまま利用した。

3.  **分析用データセットの生成**:
    上記の前処理を経たデータは、`export/dataset/`ディレクトリにCSVファイルとして保存される。

### 2.3. 再現環境と実行手順

- 環境: `requirements.txt`の環境を使用（Pythonバージョンは同ファイル準拠）
- 乱数: 再現性担保のため、乱数シード値を固定（例: 42）
- 手順:
  1) 前処理の実行: ルートの`process_race_data.py`（または`horse_racing/data/process_race_data.py`）を実行し、`export/dataset/`に分析用CSVを出力
  2) 特徴量算出と分析: `analyze_horse_racelevel.py`（または`horse_racing/analyzers/race_level_analyzer.py`）を実行
  3) 出力: 図表とキャッシュは`results/race_level_analysis/<期間>/`配下に保存（既存成果物と整合）

## 第3部：分析設計と技術的アプローチ（設計図）

### 3.1. 特徴量エンジニアリング：`HorseRaceLevel` の算出ロジック
本分析の対象である`HorseRaceLevel`は、以下の2ステップで算出される。
そのロジックの背景にあるドメイン知識と統計的判断を以下に詳述する。

#### **Step 1: 個別レースの「質」の定量化 (`RacePoint`)**
各レースに与えられる`RacePoint`は、以下の要素を重み付き合計して算出される。

`RacePoint = (基礎点) * (補正係数)`

**1. 基礎点：レースの基本的な「格」**
`基礎点 = (グレードレベル * w₁) + (レース場所レベル * w₂) + (距離レベル * w₃)`

ここで、w₁, w₂, w₃は各要素と複勝率の相関強度に基づいて決定される重みであり、次式のように正規化して定義する:
`w_i = r_i^2 / (r_grade^2 + r_venue^2 + r_distance^2)`。

-   **`グレードレベル`**:
    -   **定義**: G1から未勝利戦までの公式格付けを、`G1=9`から始まる等間隔の順序尺度に変換したものである。
    -   **採用理由**: レースの公式な権威性を直接的にモデルへ導入するため、基本要素として採用した。

-   **`レース場所レベル`**:
    -   **定義**: 競馬場を格式と重要度に基づいて階層分類し、数値化した指標である。
    -   **統計的妥当性**: 東京・中山・阪神・京都等の中央開催主要4場は最高レベル、その他中央開催場は中レベル、地方開催場は基本レベルとして体系化。
    -   **採用理由**: 同一グレードでも開催場所により競争レベルが異なるため、競馬場の格式を数値化してレース価値の精度を向上させる目的で採用した。

-   **`距離レベル`**:
    -   **定義**: レース距離を5つのカテゴリー（スプリント/マイル/中距離/中長距離/長距離）に分類し、競争レベルに応じた価値係数を適用した指標。
    -   **統計的妥当性**: 距離と競争レベルの関係は非線形であり、2000m前後で最高値を取る山型分布を示す。
    -   **採用理由**: 同一格式・同一賞金でも距離により競争価値が変動するため、この影響を数値化して基礎点に組み込む。

-   **重み決定プロセス**:
    -   **個別相関分析**: 各要素（グレード※欠損値を賞金で補完、レース場所、レース距離）を個別に複勝率と相関分析
    -   **相関強度ベース重み**: r²（決定係数）を用いた正規化により各要素の重みを決定
    -   **検証**: クロスバリデーションとドメイン知識による妥当性確認
        - **クロスバリデーション**: 6年間のデータ（2018-2023年）を時系列で5分割し、各分割をテスト用に順次使用。例：分割1（2018年）をテスト用に残し、残り4年分で重み計算→テスト用で性能評価、これを5回繰り返す。各回で算出される重みの変動幅（標準偏差）が小さければ安定性を確認。
        - **ドメイン知識確認**: 統計的に算出された重みが競馬の専門知識と整合するかを検証。グレード > 場所 > 距離の重要度順序など、業界常識との一致を確認する。

**2. 補正係数：ドメイン知識に基づく価値の調整**

-   **`距離ボーナス`**:
    -   **定義**: 特定の距離カテゴリのレースに対し、補正係数を乗算する。
    -   **パラメータ決定**: 「クラシック路線」と呼ばれる2000m前後のレースは競争が激化するというドメイン知識をモデルに組み込むため、補正係数を1.0～2.0の範囲で0.05刻みで変化させ、各係数での複勝率との相関を測定。グリッドサーチの結果、1.35倍で相関が最大となったため採用。これは日本ダービー（2400m）、皐月賞（2000m）等の主要G1レースが集中する距離帯の競争価値を適切に反映した値である。

-   **`交互作用ボーナス`**:
    -   **定義**: 特定の「グレード」と「距離」の組み合わせに対し、交互作用を考慮したボーナス係数を適用する。
    
    | グレード     | 距離カテゴリ   | ボーナス係数 | 根拠                                                                 |
    | :----------- | :------------- | :----------- | :------------------------------------------------------------------- |
    | G1, G2, G3   | 1800m - 2400m  | 1.15倍       | クラシック路線や主要G1レースが集中する、最も競争が激しい区間であるため。 |
    
    **係数決定の根拠**:
    - **1.15倍の選択**: 距離ボーナス（1.35倍）との重複適用を考慮し、過度な重み付けを避けるため1.15倍に設定。グレード単体での重みが既に高いため、適度な上乗せに留める。
    - **G3より低いグレードを除外**: 重賞以下のグレードでは1800m-2400mの距離帯でも競争レベルにばらつきが大きく、一律のボーナス適用が不適切。G1-G3のみが安定した高競争レベルを保持するため対象を限定。

#### **Step 2: 馬ごとの実績集約 (`HorseRaceLevel`)**
上記の`RacePoint`を基に、各馬に対し2種類の`HorseRaceLevel`を算出する。

-   **`AvgRaceLevel` (平均レースレベル)**:
    -   **算出方法**: 当該馬が過去に出走した全レースの`RacePoint`の平均値。
    -   **分析上の意味**: キャリアを通じたパフォーマンスの一貫性や、平均的な活動ステージのレベルを示す。

-   **`MaxRaceLevel` (最高レースレベル)**:
    -   **算出方法**: 当該馬が過去に出走した全レースの`RacePoint`の最大値。
    -   **分析上の意味**: キャリアにおける最大到達能力（ポテンシャル）やピークパフォーマンスを示す。

### 3.2. 検証する作業仮説
設計した合成特徴量 `HorseRaceLevel` が競走馬の能力を定量化する指標として有効に機能するかを検証するため、以下の3つの作業仮説を設定する。

#### **仮説1: `HorseRaceLevel`は競走能力の予測に有効である。**
-   **帰無仮説 (H₀)**: `HorseRaceLevel`と複勝率の相関係数 ρ は0である (ρ = 0)。
-   **対立仮説 (H₁)**: `HorseRaceLevel`と複勝率の間には、統計的に有意な正の相関関係が存在する (ρ > 0)。
-   **本仮説検証の意義**:
    1.  競馬のデータ分析において、過去の競走履歴から将来のパフォーマンスを予測することは最重要な内容。
    2.  `HorseRaceLevel`が有効であれば、勝利数や着順といった単純な実績指標よりも高次元な能力評価が可能となる。
    3.  本特徴量は、競馬予測サービスにおける精度向上や、データプロダクトとしての商業的価値に寄与する可能性がある。
-   **検証方法**:
    -   **説明変数**: `AvgRaceLevel`, `MaxRaceLevel`
    -   **目的変数**: `place_rate` (複勝率)
        - **選定理由**: 馬の安定した競争力を測るため「複勝率」を目的変数として採用した。走破タイムは馬場状態・天候・ペース等の外的要因に左右されるが、複勝率は競争相手との相対的な強さを表すため環境要因の影響を受けにくい。また、勝率（1着）は競走馬1頭当たり年数回程度と稀な現象だが、複勝率（3着以内）は約3倍の頻度で発生するため、統計分析に必要な十分なデータ量を確保できる。
    -   **分析手法**: 散布図による可視化、相関係数の算出、および統計的有意性検定（p < 0.05）。主要統計はPearson（線形関係）とSpearman（順位相関）の両方を併記し、95%信頼区間を提示する。

#### **仮説2: 平均レベルと最高レベルでは、予測力に差がある。**
-   **帰無仮説 (H₀)**: `AvgRaceLevel`と`MaxRaceLevel`の複勝率に対する予測力は等しい。
-   **対立仮説 (H₁)**: いずれか一方の指標が、より強い予測力を持つ。
-   **本仮説検証の意義**:
    1.  実務応用上、予測性能と計算コストのバランスを考慮し、最も寄与度の高い指標を選択することが求められる。
    2.  両指標の予測寄与度を比較することで、「平均的な能力」と「最大能力」のどちらが将来の成績と強く関連するかを評価し、予測モデルの戦略を決定できる。
-   **検証方法**:
    -   **比較対象**: `AvgRaceLevel`と`MaxRaceLevel`それぞれの相関係数。
    -   **評価基準**: 相関の強さ、決定係数（R²）、解釈性。 TODO:解釈性はどうやって評価する？

#### **仮説3: この分析手法は、異なる時期のデータでも再現性がある。**
-   **帰無仮説 (H₀)**: 異なるデータ期間において、`HorseRaceLevel`の有効性は再現されない。
-   **対立仮説 (H₁)**: 複数のデータ期間で、一貫して`HorseRaceLevel`と複勝率の正の相関が観測される。
-   **本仮説検証の意義**:
    1.  構築した指標の有効性が特定の期間に限定されず、時系列的に安定していることを示すことは、その指標の普遍性と信頼性を担保する上で不可欠である。
    2.  時間的普遍性を欠く指標は外的要因の変化に脆弱であり、実務的な応用価値が低い。
    3.  指標の有効性が時系列で安定していることを確認できれば、これを組み込んだ持続可能な予測モデルの構築が可能となる。
-   **検証方法**:
    -   **分析対象**: 3年間隔での分析。
    -   **評価基準**: 各期間で算出された相関係数の一貫性。
    -   **実務への応用**: 結果の安定性に基づき、本指標の実用化の可否を判断する。

## 第4部：実験計画と検証戦略

### 4.1 実験設計の概要

本分析の信頼性と客観性を担保するため、ランダム化と層別化を組み込んだ実験計画を策定する。これにより、選択バイアスの除去と結果の一般化可能性を向上させる。

#### 4.1.1 実験の全体設計

**研究目的**: `HorseRaceLevel`が従来の単純集計手法（勝率・複勝率）よりも優れた競走能力予測指標であることを統計的に実証する。

**比較対象**:
- **提案手法**: `AvgRaceLevel`, `MaxRaceLevel`
- **従来手法**: 単純勝率、単純複勝率、勝利数
- **評価指標**: 複勝率との相関係数（Pearson, Spearman）

### 4.2 層別化によるバイアス制御

競馬データ特有の偏りを除去するため、以下の3軸による層別化を実施する。

#### 4.2.1 層別化の設計

**軸1: 馬齢層**
- **2歳馬**: キャリア初期、成長途上の評価
- **3歳馬**: クラシック世代、能力が確立される時期  
- **4歳以上馬**: 成熟馬、安定した能力発揮期

**軸2: 競走経験層**
- **少経験馬**: 1-5戦（キャリア初期）
- **中経験馬**: 6-15戦（能力評価が安定化）
- **多経験馬**: 16戦以上（十分な実績蓄積）

**軸3: 主戦距離層**
- **短距離専門**: 主要出走距離 ≤ 1400m
- **マイル専門**: 主要出走距離 1401-1800m  
- **中長距離専門**: 主要出走距離 ≥ 1801m

#### 4.2.2 層別化の統計的根拠

各層の設定は、競馬のドメイン知識と統計的考慮に基づく：

1. **馬齢による成長曲線**: 馬の能力発達パターンが年齢により異なる
2. **経験値による学習効果**: 出走回数と安定性の関係性
3. **距離適性による専門化**: 距離特性が能力評価に与える影響

### 4.3 データ分割とサンプリング手順

#### 4.3.1 Step 1: 時系列による訓練・検証データ分割（Out-of-Time検証）
本分析の信頼性を担保する最重要プロセスとして、まずデータを時系列で厳密に分割します。これにより、未来の情報が過去の分析に漏洩（リーケージ）することを完全に防ぎます。

- **訓練期間 (In-Sample):** `2018-01-01` 〜 `2020-12-31`
  - **目的:** 特徴量の重み（w）や補正係数など、モデルの全パラメータを**この期間のデータのみを用いて**決定します。
- **検証期間 (Out-of-Sample):** `2021-01-01` 〜 `2023-12-31`
  - **目的:** 訓練期間で決定したパラメータを**一切変更せず**に、モデルの予測性能が将来の未知データに対しても維持されるか（汎化性能）を評価します。この方法は、モデルの頑健性を測る信頼性の高い**Out-of-Time（OOT）検証**です。

#### 4.3.2 Step 2: 訓練・検証データセット内での層化サンプリング

**1. 目的**
時系列分割後の各データセット（訓練/検証）において、特定の属性（馬齢、競走経験など）の分布が母集団の比率から偏らないように調整し、かつ分析の計算負荷を管理するために層化サンプリングを適用します。これにより、評価の信頼性を高めます。

**2. 手続き**
前ステップで時間的に分離された訓練データセットと検証データセットに対し、**それぞれ独立に**以下のサンプリング処理を適用します。

-   **2-1. 訓練データセット内での層化サンプリング:**
    -   **入力:** 訓練期間（2018-2020）の全データ
    -   **処理:** 馬齢、競走経験、主戦距離の組み合わせで定義される「層」を作成します。各層の構成比率を維持したまま、指定されたサンプルサイズまたは比率に基づき、無作為にデータを抽出（非復元抽出）します。
    -   **出力:** 層化サンプリングされた訓練データ

-   **2-2. 検証データセット内での層化サンプリング:**
    -   **入力:** 検証期間（2021-2023）の全データ
    -   **処理:** 訓練データと同様に、検証データ内でも層を作成し、層の比率を維持しながらデータを無作為に抽出します。
    -   **出力:** 層化サンプリングされた検証データ

**3. 理論的根拠と重要性**

-   **なぜこの順序が絶対か（情報リーケージの厳密な防止）:**
    競馬データは、ある時点の馬の成績が過去の成績に依存する**時系列データ**の認識です。もしデータ全体からランダムサンプリングしてしまうと、時間軸がシャッフルされ、**未来のレース結果（検証期間）をモデルが学習し、過去のレース（訓練期間）を予測する**という、致命的な**情報リーケージ**が発生します。これは、未来の試験問題を見てから過去の模擬試験を受けるに等しく、得られたモデル評価は過度に楽観的なものとなり、全く信頼できません。したがって、「**1. 時系列分割 → 2. 分割後データ内でのサンプリング**」という順序は、分析の妥当性を保証する上で絶対的な原則です。

-   **層化サンプリングの役割（分散の低減と代表性の確保）:**
    単純な無作為抽出では、偶然、特定の層（例: 2歳馬）が極端に多くなったり少なくなったりする可能性があります。層化サンプリングは、データセット全体の縮図となるように各層の比率を維持するため、サンプリングによる評価指標の**分散を低減**し、より安定した信頼性の高い評価を可能にします。

#### 4.3.3 事前検定力分析に基づくサンプルサイズの設計

**1. 目的と必要性**
本分析では、信頼性と効率性を両立させるため、事前に**検定力分析（Power Analysis）**を実施し、各層で必要なサンプルサイズを決定します。

目的は以下の2つのエラーを制御することです。
- **第一種の過誤（Type I Error, α, 偽陽性）**: 本当は効果がないのに、偶然「効果あり」と結論づけてしまうリスク。
- **第二種の過誤（Type II Error, β, 偽陰性）**: 本当に効果があるのに、データ不足で「効果なし」と見逃してしまうリスク。

適切なサンプルサイズを設計することで、無駄なデータ収集コストを避けつつ、意味のある結果を見逃す可能性を低減させます。

**2. パラメータ設定と根拠**
検定力分析には、以下の3つのパラメータを事前に設定する必要があります。

-   **目標効果量 (Effect Size, r): `0.40`（中〜大効果）**
    -   **定義:** この分析で検出し、実用上「強い価値がある」と判断したい相関の強さの目標値です。
    -   **根拠:** 本指標は、競馬予測で高実績のある著者の本内容を考慮したものであるため、単なる「小〜中程度の効果」(`r=0.2~0.3`)に留まらず、予測において明確な主軸となりうる「中〜大程度の効果」を目指す価値があります。`r=0.40` は、Cohenの基準でも「中効果」の上限に近く、十分に挑戦的でありながら、バランスの取れた目標値です。この目標を達成できれば、本指標が予測モデルの根幹をなす候補であることを強く示唆します。

-   **有意水準 (Significance Level, α): `0.05`**
    -   **定義:** 第一種の過誤を犯す確率の上限値です。
    -   **根拠:** これは統計的仮説検定における慣例的な基準です。「もし本当は相関がない場合でも、偶然のデータによって『相関あり』と誤って結論づけてしまう確率を5%未満に抑える」ことを意味します。

-   **検出力 (Statistical Power, 1-β): `0.80`**
    -   **定義:** 第二種の過誤を避けられる確率、すなわち、目標とする効果量（`r=0.40`）が本当に存在した場合に、それを見逃さずに正しく「相関あり」と検出できる確率です。
    -   **根拠:** これも慣例的な基準であり、「もし `r=0.40` の相関が本当に存在するなら、80%の確率でそれを見つけ出す」という目標を設定します。これにより、意味のある結果を見逃すリスクを20%（β）に抑えます。

**3. サンプルサイズの計算**
上記のパラメータに基づき、必要なサンプルサイズ `n` を算出します。
計算には、統計解析ソフトウェア（例: G*Power）やPythonの統計ライブラリが利用できます。
本分析のように再現性を重視するパイプラインでは、コードベースでの計算が推奨されます。

以下に、Pythonの`pingouin`ライブラリを用いた計算コード例と、その結果を示します。

```python
import pingouin as pg

# 1. 設計目標として設定した3つのパラメータを定義
effect_size = 0.40  # 目標効果量 (相関係数r)
alpha = 0.05        # 有意水準 (p値の閾値)
power = 0.80        # 検出力 (1-β)

# 2. 3つのパラメータを満たすために必要なサンプルサイズ(n)を計算
required_n = pg.power_corr(
    r=effect_size,
    power=power,
    alpha=alpha,
    tail='two-sided'  # 両側検定
)

print(f"計算された必要なサンプルサイズ: {required_n:.0f}")
# > 計算された必要なサンプルサイズ: 46
```

**4. 結論：採用するサンプルサイズ**
上記の計算結果から、**各層あたり n = 46 のサンプルが必要**であると結論付けられます。

したがって、本分析では各層で最低46頭の競走馬データを確保することを目指します。このサンプル数は、検定力を満たしつつ、結果の安定性を考慮しても現実的な下限値です。もし層のサンプル数がこれを下回る場合は、統計的検出力が低下し、結果の信頼性が損なわれる可能性があることを明記します。

### 4.4 統計的検証プロセス

#### 4.4.1 仮説検定の設計

第3部で設定した作業仮説を、層別化された各グループで個別に検証する。

**層別仮説**:
各層において第3部の仮説を個別に検証し、効果の一貫性を確認

**有意水準**: α = 0.05（Bonferroni補正適用時: α' = 0.05/層数）
    - **α = 0.05の意味**: 偶然でこの結果が出る確率が5%以下なら「統計的に意味がある」と判定する基準
    - **補正の必要性**: 複数の層で同時に検定すると、偶然有意になる確率が増加するため、より厳しい基準（有意水準を層数で割る）を適用して誤判定を防ぐ
    - **具体例**: 3つの馬齢層で分析する場合、α' = 0.05/3 = 0.0167となり、各層でp値が1.67%未満でないと有意と認めない

#### 4.4.2 効果量の評価

**相関係数の解釈基準** (Cohen, 1988):
- 小効果: |r| = 0.1
- 中効果: |r| = 0.3
- 大効果: |r| = 0.55

**比較評価**:
提案手法と従来手法の相関係数差を効果量として評価

### 4.5 検証手順の実装

#### 4.5.1 段階的検証プロセス

**Phase 1: 層別内検証**

層別化された各グループ（馬齢・競走経験・主戦距離別）において、個別に統計分析を実行する。
具体的には、各層のHorseRaceLevelと複勝率の相関係数を算出し、統計的検定によりp値を求める。さらに各層のサンプル数も記録し、層別の分析結果を体系的に整理・比較する。

**Phase 2: 層間比較**
- 各層での効果サイズを比較
- 層による効果の異質性を検定（Q統計量）

**具体例**:
```
各グループの効果比較：

2歳馬: HorseRaceLevelと複勝率の関係は「弱い」
3歳馬: HorseRaceLevelと複勝率の関係は「中程度」
4歳以上: HorseRaceLevelと複勝率の関係は「強い」

Q統計量による判定：
→ 「この3つのグループの効果の違いは偶然ではない」
→ つまり、馬の年齢によって本当にHorseRaceLevelの効きやすさが違う

実用的な意味：
- 2歳馬では参考程度
- 3歳馬では予測に使える
- 4歳以上では信頼性の高い予測が可能
```

**Phase 3: 統合分析**
- 各層の分析結果をまとめて、全体的な効果の大きさを算出
- 層間の違いを考慮しながら、統計的に適切な方法で結果を統合

**具体例**:
```
各馬齢グループで調べた結果：

2歳馬グループ：
HorseRaceLevelが高い馬ほど複勝率が良い傾向はあるが、関係は弱め

3歳馬グループ：
HorseRaceLevelが高い馬ほど複勝率が良い傾向がそこそこ見られる

4歳以上グループ：
HorseRaceLevelが高い馬ほど複勝率が明らかに良い

統合した結論：
→ HorseRaceLevelは競走馬の複勝率予測に使える指標
→ ただし年齢が上がるほど効果が大きくなる
→ 若い馬より成熟した馬でより信頼できる予測ができる
```

### 4.6 実験計画の意義と限界

#### 4.6.1 本実験設計の強み

1.  **結果の信頼性検証（シミュレーションによる頑健性の確保）**
    本設計の強みは、観測された相関係数が偶然の産物（**ノイズ**）ではなく、意味のある関連性（**シグナル**）であることを、計算機シミュレーションを用いて直接的に検証する点にあります。

    -   **手法：順列検定（Permutation Test）**
        この検証には、t検定のようにデータが特定の確率分布（例: 正規分布）に従うといった理論的な**「仮定」を必要としない**、ノンパラメトリックな手法を用います。

    -   **検証プロセス（信号対ノイズ比の評価）**
        1.  **ノイズの測定**: 片方の変数（例: 複勝率）の並びをランダムにシャッフルし、意図的に変数間の関係を破壊します。この操作を数千〜数万回繰り返し、システムが**偶然だけで生成しうる相関係数（ノイズ）の分布**を経験的に測定します。
        2.  **判定**: 実際のデータから得られた相関係数（**シグナル**）が、このノイズ分布の中で統計的に十分に稀な（例: 上位5%に入るほど強力な）値であれば、「観測された相関は単なるノイズではない」と結論付けます。

2. **一般化可能性**: 層別化により様々な条件での有効性を検証
3. **実務適用性**: 条件別の有効性が明確になり実装方針が決定可

#### 4.6.2 限界と今後の課題

**この研究の限界**:
- 過去のデータを調べただけなので、「HorseRaceLevelが高いから複勝率が良い」と断言できない
- 調べていない他の要因（調教師の腕、厩舎の環境など）が影響している可能性がある

**適用範囲の限界**:
- 日本の平地競走のみの分析なので、海外競馬や障害競走で使えるかは不明
- 2026年以降の競馬で同じ効果があるかは確認が必要

**今後の改善案**:
- より長い期間のデータで安定性を確認
- 複勝率以外（勝率や収益性）でも効果があるか調査
- 機械学習等と組み合わせてさらに精度向上を目指す

TODO: ここから下は、実施後に追記。
## 第5部：分析結果と考察

### 5.1. 層別分析結果
#### 5.1.1. 馬齢層別の効果検証
#### 5.1.2. 競走経験層別の効果検証
#### 5.1.3. 主戦距離層別の効果検証
#### 5.1.4. Q統計量による層間異質性検定

### 5.2. 仮説検証（層別結果を基に）
#### 5.2.1. 仮説1の検証：`HorseRaceLevel`の予測有効性
- 相関分析結果
- 統計的有意性検定
- 効果量の評価（Cohen基準）

#### 5.2.2. 仮説2の検証：平均レベルvs最高レベルの予測力比較
- `AvgRaceLevel`と`MaxRaceLevel`の相関係数比較
- 決定係数（R²）による寄与度分析
- 実用性の観点からの評価

#### 5.2.3. 仮説3の検証：時系列安定性と再現性
- 期間別相関分析（2018-2020 vs 2021-2023）
- 相関係数の一貫性評価
- 外的妥当性の検証

### 5.3. 統合分析と総合評価
#### 5.3.1. 全層統合での総合効果
#### 5.3.2. 従来手法との比較評価
#### 5.3.3. 実用化への提言

## 結論：本ポートフォリオで示した能力

---

## 参考文献（抜粋）
- JRA 公式資料、JRDB 仕様書（各利用規約に準拠）
- 書籍「競馬の教科書　発想を変えるだけで回収率は上がる」